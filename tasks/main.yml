---
# tasks file for apt
- name: sources.list
  template:
    src: "sources.list.{{ ansible_lsb.id | default (ansible_os_family) }}.j2"
    dest: /etc/apt/sources.list
    backup: true
    owner: root
    group: root
    mode: 0644
  notify:
    - update cache
  tags:
    - apt
    - sources.list

- import_tasks: dpkg.yml

- name: network options
  template:
    src: network.j2
    dest: /etc/apt/apt.conf.d/30network
    owner: root
    group: root
    mode: 0644
  when:
    proxy_env is defined or
    apt_pad is defined
  tags:
    - apt
    - network

- name: backports
  template:
    src: backports.list.j2
    dest: /etc/apt/sources.list.d/backports.list
    owner: root
    group: root
    mode: 0644
  notify:
    - update cache
  when:
    - apt_backports is defined
    - apt_backports
  tags:
    - apt
    - sources
    - backports

- name: remove backports.list
  file:
    path: /etc/apt/sources.list.d/backports.list
    state: absent
  notify:
    - update cache
  when:
    apt_backports is not defined or
    not apt_backports
  tags:
    - apt
    - sources
    - backports

- name: additional repositories preferences
  template:
    src: extra.preferences.j2
    dest: "/etc/apt/preferences.d/{{ item.filename }}"
    owner: root
    group: root
    mode: 0644
  loop: "{{ apt_repositories }}"
  notify:
    - gen caches
  when:
    - apt_repositories is defined
    - item.apt_pin_priority is defined
  tags:
    - apt
    - extra
    - preferences

- name: additional repositories
  apt_repository:
    filename: "{{ item.filename }}"
    repo: "{{ item.repo }}"
    state: "{{ item.state }}"
    update_cache: false
  loop: "{{ apt_repositories }}"
  notify:
    - update cache
  when: apt_repositories is defined
  tags:
    - apt
    - sources.list.d
    - repositories

- name: proposed-updates preferences
  file:
    path: /etc/apt/preferences.d/proposed-updates
    state: absent
  notify:
    - gen caches
  when:
    apt_proposed_updates is not defined or
    apt_proposed_updates|lower() in ['false','no']
  tags:
    - apt
    - preferences
    - proposed-updates

- name: proposed-updates preferences
  template:
    src: updates.preferences.j2
    dest: /etc/apt/preferences.d/proposed-updates
    owner: root
    group: root
    mode: 0644
  notify:
    - gen caches
  when:
    - apt_proposed_updates is defined
    - apt_proposed_updates|lower() in ['true','yes']
  tags:
    - apt
    - preferences
    - proposed-updates

- name: apt-daily timer override dir
  file:
    path: /etc/systemd/system/apt-daily.timer.d
    state: directory
    owner: root
    group: root
    mode: 0755
  when:
    apt_timer_oncalendar is defined or
    apt_timer_randomizeddelaysec is defined or
    apt_timer_persistent is defined
  tags:
    - apt
    - timer

- name: apt-daily timer override
  template:
    src: apt-daily.timer.override.conf.j2
    dest: /etc/systemd/system/apt-daily.timer.d/override.conf
    owner: root
    group: root
    mode: 0644
  when:
    apt_timer_oncalendar is defined or
    apt_timer_randomizeddelaysec is defined or
    apt_timer_persistent is defined
  notify:
    - systemd reload
  tags:
    - apt
    - timer

- name: remove apt-daily timer override
  file:
    path: /etc/systemd/system/apt-daily.timer.d/override.conf
    state: absent
  when:
    not (
    apt_timer_oncalendar is defined or
    apt_timer_randomizeddelaysec is defined or
    apt_timer_persistent is defined
    )
  notify:
    - systemd reload
  tags:
    - apt
    - timer

- name: remove apt-daily timer override dir
  file:
    path: /etc/systemd/system/apt-daily.timer.d
    state: absent
  when:
    not (
    apt_timer_oncalendar is defined or
    apt_timer_randomizeddelaysec is defined or
    apt_timer_persistent is defined
    )
  tags:
    - apt
    - timer
